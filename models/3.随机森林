from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import GridSearchCV
from sklearn.pipeline import Pipeline

def create_random_forest_model(preprocessor, class_weight_dict=None):
    """创建随机森林模型"""
    if class_weight_dict is None:
        class_weight_dict = 'balanced'
    
    model = Pipeline(steps=[
        ('preprocessor', preprocessor),
        ('classifier', RandomForestClassifier(n_estimators=100, random_state=42, 
                                            class_weight=class_weight_dict))
    ])
    
    return model

def tune_random_forest(model, X_train, y_train):
    """随机森林超参数调优"""
    param_grid = {
        'classifier__n_estimators': [50, 100, 200],
        'classifier__max_depth': [None, 10, 20],
        'classifier__min_samples_split': [2, 5, 10]
    }
    
    grid_search = GridSearchCV(model, param_grid, cv=5, scoring='roc_auc', n_jobs=-1)
    grid_search.fit(X_train, y_train)
    
    print(f"随机森林最佳参数: {grid_search.best_params_}")
    return grid_search.best_estimator_

def plot_random_forest_feature_importance(model, feature_names, top_n=15):
    """绘制随机森林特征重要性"""
    import matplotlib.pyplot as plt
    import seaborn as sns
    
    if hasattr(model, 'named_steps'):
        classifier = model.named_steps['classifier']
    else:
        classifier = model
    
    if hasattr(classifier, 'feature_importances_'):
        importance = classifier.feature_importances_
        
        feature_imp_df = pd.DataFrame({
            'feature': feature_names[:len(importance)],
            'importance': importance
        }).sort_values('importance', ascending=False)
        
        plt.figure(figsize=(12, 8))
        top_features = feature_imp_df.head(top_n)
        sns.barplot(data=top_features, x='importance', y='feature', palette='viridis')
        plt.title(f'随机森林 - Top {top_n} 特征重要性', fontsize=16, fontweight='bold')
        plt.xlabel('重要性', fontsize=12)
        plt.ylabel('特征名称', fontsize=12)
        plt.tight_layout()
        plt.show()
        
        return feature_imp_df
    else:
        print("模型不支持特征重要性分析")
        return None
